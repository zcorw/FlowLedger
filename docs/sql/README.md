# Flow-Ledger SQL 说明书（PostgreSQL 12+）

本说明书聚焦数据库层设计与实现，涵盖模块化 Schema、表结构、约束与索引、时间与精度规范、分区与归档、一致性与幂等、权限与变更管理等。本文不包含 API 或图表文件。

## 1) 范围与需求映射
- 模块与实体
  - currency：currencies、exchange_rates → 多币种统一换算、历史汇率查询
  - "user"：users、user_prefs → 用户上下文、偏好（默认货币、时区）
  - deposit：institutions、accounts、account_balances → 存款账户与余额时间序列
  - expense：expense_categories、expenses → 消费记录与分类
  - loan：counterparties、loans、loan_schedules、loan_txns → 借贷、还款计划与记录
  - scheduler：jobs、job_runs、reminders、confirmations → 定时任务、提醒、确认回执（自动记账触发）
- 业务规则映射
  - 金额使用 NUMERIC，高精度计算；时间统一 UTC（TIMESTAMPTZ）
  - 所有财务数据关联具体用户（除全局表如 currencies）
  - 支持历史数据查询与统计汇总（时间索引、分区、物化视图建议）

## 2) 统一规范
- 命名
  - Schema：currency, "user", deposit, expense, loan, scheduler
  - 表/列：snake_case
  - 主键：pk_<table>；外键：fk_<from>__<to>；唯一：uq_<table>__<cols>
  - 检查：ck_<table>__<rule>；索引：idx_<table>__<cols>_(asc|desc)
- 数据类型选型
  - ID：GENERATED BY DEFAULT AS IDENTITY（统一使用）
  - 金额/数量：NUMERIC(20,6)
  - 汇率：NUMERIC(20,10)
  - 布尔：BOOLEAN
  - 时间：TIMESTAMPTZ（存 UTC）
- 审计字段
  - created_at TIMESTAMPTZ NOT NULL DEFAULT now()
  - updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
  - 推荐在更新时自动触发 updated_at（触发器示例见下）
- 外键策略
  - 默认 NO ACTION/RESTRICT；确需级联删除时需在表内显式声明并给出理由
- 分区/归档策略
  - 时间序列大表建议按月分区：PARTITION BY RANGE (ts_col)
  - 历史归档：冷数据迁移至归档 Schema 或外部分区
- 枚举实现
  - 优先 CHECK 约束控制状态值；跨表共享常量可用 DOMAIN 或 ENUM（需演进考虑）

通用 updated_at 触发器（可复用）：
```sql
-- 可选：在 public 建通用更新时间触发器
CREATE OR REPLACE FUNCTION public.tg_set_updated_at()
RETURNS trigger LANGUAGE plpgsql AS $$
BEGIN
  NEW.updated_at := now();
  RETURN NEW;
END $$;
```

## 3) 跨模块关系（文字）
- 用户→资产/消费/借贷：各业务表通过 user_id 关联 "user".users.id
- 货币→汇率→统一换算：currency.currencies 与 currency.exchange_rates 提供换算与历史查询
- 调度任务→提醒回执→自动记账：scheduler.jobs→reminders/confirmations；确认完成触发 expense.expenses 生成

## 4) 全局视图与物化视图建议
- 统一资产视图 report.v_user_net_worth（示例）
  - 汇总 deposit.account_balances 最新余额（示例）并留待应用层统一换算
```sql
CREATE SCHEMA IF NOT EXISTS report;

CREATE OR REPLACE VIEW report.v_user_net_worth AS
SELECT u.id AS user_id,
       coalesce(sum(b.amount_base_ccy), 0)::numeric(20,6) AS net_worth_base
FROM "user".users u
LEFT JOIN LATERAL (
  -- 示例：取每账户最新余额并假设已换算为用户默认货币 amount_base_ccy
  SELECT a.user_id, ab.amount AS amount_base_ccy
  FROM deposit.accounts a
  JOIN deposit.account_balances ab ON ab.account_id = a.id
  WHERE a.user_id = u.id
  AND ab.as_of = (
    SELECT max(as_of) FROM deposit.account_balances ab2 WHERE ab2.account_id = a.id
  )
) b ON true
GROUP BY u.id;
```
- 日汇率快照 report.mv_fx_daily（示例）
```sql
CREATE MATERIALIZED VIEW IF NOT EXISTS report.mv_fx_daily AS
SELECT base_code, quote_code, rate_date, avg(rate) AS avg_rate
FROM currency.exchange_rates
GROUP BY base_code, quote_code, rate_date;

-- 刷新策略：每日定时
-- 注意：CONCURRENTLY 刷新需要物化视图有唯一索引，按需添加
-- REFRESH MATERIALIZED VIEW report.mv_fx_daily;
```

## 5) 变更管理
- 版本化迁移：采用 Flyway/dbmate 风格命名，如 V1__init.sql, V1_1__add_index.sql
- 回滚策略：为每个迁移提供逆向脚本；避免长事务，拆分 DDL 与数据回填
- 兼容性与热变更：新增列默认 NULL；必要时双写/回填并分步切换；索引创建可用 CONCURRENTLY（独立事务执行）

## 6) 校验清单
- 可执行性：DDL 在 PostgreSQL 12+ 可执行
- 索引覆盖：高频过滤列与外键列均有索引
- 外键与唯一性：约束命名规范统一，违反时清晰报错
- 时区一致：TIMESTAMPTZ，应用层负责入库即 UTC
- 金额精度：NUMERIC(20,6)/(20,10)；禁止浮点
- 性能阈值：常用查询 P95 < 200ms（有合适索引与限制的查询范围）


# User 模块 SQL 说明书

注意：Schema 名为 "user"（保留字），需使用引号引用。

## 1. 模块范围与实体清单
- 职责：用户身份、Telegram 绑定标识、用户偏好
- 依赖：被所有业务模块作为外键引用；引用 currency.currencies
- 实体
  - users：用户主体，含可选 telegram_user_id
  - user_prefs：用户偏好（默认货币、时区、语言）

## 2. 数据字典
（字段说明补充）

- "user".users 字段说明
  - id：用户ID，自增主键
  - telegram_user_id：绑定的 Telegram 用户ID（可空，唯一）
  - is_bot_enabled：是否启用 Bot 交互
  - created_at/updated_at：审计时间（UTC）

- "user".user_prefs 字段说明
  - id：偏好记录ID，自增主键
  - user_id：关联用户ID（唯一一对一），删除用户时级联删除
  - base_currency：默认展示/统计货币代码（引用 currency.currencies）
  - timezone：用户时区（IANA/自定义字符串）
  - language：语言偏好（如 zh-CN）
  - created_at/updated_at：审计时间（UTC）
- "user".users
  - id | BIGINT PK
  - telegram_user_id | BIGINT NULL UNIQUE（可空）| 绑定的 Telegram ID
  - is_bot_enabled | BOOLEAN NOT NULL DEFAULT true | 是否启用 Bot
  - created_at/updated_at | TIMESTAMPTZ | 审计

- "user".user_prefs
  - id | BIGINT PK
  - user_id | BIGINT FK users(id) UNIQUE
  - base_currency | TEXT FK currency.currencies(code)
  - timezone | TEXT NOT NULL
  - language | TEXT NOT NULL DEFAULT 'zh-CN'
  - created_at/updated_at | TIMESTAMPTZ | 审计

## 3. DDL（可执行）
```sql
CREATE SCHEMA IF NOT EXISTS "user";

CREATE OR REPLACE FUNCTION "user".tg_set_updated_at()
RETURNS trigger LANGUAGE plpgsql AS $$
BEGIN NEW.updated_at := now(); RETURN NEW; END $$;

CREATE TABLE IF NOT EXISTS "user".users (
  id               BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  telegram_user_id BIGINT NULL UNIQUE,
  is_bot_enabled   BOOLEAN NOT NULL DEFAULT true,
  created_at       TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at       TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TRIGGER trg_users__upd
BEFORE UPDATE ON "user".users
FOR EACH ROW EXECUTE FUNCTION "user".tg_set_updated_at();

CREATE TABLE IF NOT EXISTS "user".user_prefs (
  id            BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id       BIGINT NOT NULL UNIQUE REFERENCES "user".users(id) ON DELETE CASCADE,
  base_currency TEXT   NOT NULL REFERENCES currency.currencies(code) ON DELETE RESTRICT,
  timezone      TEXT   NOT NULL,
  language      TEXT   NOT NULL DEFAULT 'zh-CN',
  created_at    TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at    TIMESTAMPTZ NOT NULL DEFAULT now(),
  CONSTRAINT ck_user_prefs__tz CHECK (length(timezone) BETWEEN 1 AND 64)
);

CREATE TRIGGER trg_user_prefs__upd
BEFORE UPDATE ON "user".user_prefs
FOR EACH ROW EXECUTE FUNCTION "user".tg_set_updated_at();

CREATE INDEX IF NOT EXISTS idx_users__telegram_user_id
ON "user".users (telegram_user_id);

-- 种子数据
INSERT INTO "user".users(telegram_user_id) VALUES (NULL) RETURNING id;
-- 假设返回 1
INSERT INTO "user".user_prefs(user_id, base_currency, timezone, language)
VALUES (1, 'CNY', 'UTC', 'zh-CN');
```

## 4. 一致性与幂等
- 唯一性：同一 telegram_user_id 仅可绑定一用户
- 幂等：以 telegram_user_id 作为 upsert 键进行绑定更新

## 5. 典型查询与性能
```sql
-- 读取用户偏好（含默认货币）
SELECT u.id, p.base_currency, p.timezone, p.language
FROM "user".users u
JOIN "user".user_prefs p ON p.user_id = u.id
WHERE u.id = $1;
```
- 性能：为 telegram_user_id、user_id 建索引；JOIN 命中 PK/UQ

## 6. 权限与安全
- 角色：app_reader/app_writer/app_admin
- 可选 RLS：按 user_id 行级隔离（一般在业务表使用）

## 7. 历史与时间序列
- 基本静态；审计字段记录创建与更新时间

## 8. 视图与物化视图（可选）
- 可提供活跃用户视图（按最近活动时间，依赖业务事件）

## 9. 迁移与回滚
- V1.1 增加 language 默认值；V1.2 增加 is_bot_enabled
- 回滚：DROP COLUMN；注意依赖默认值/检查约束

## 10. 测试与数据校验
- 校验：telegram_user_id 唯一性；外键 CASCADE 生效
- 用例：重复绑定同一 telegram_user_id 触发唯一冲突

# Scheduler 模块 SQL 说明书

## 1. 模块范围与实体清单
- 职责：定时任务、运行实例、提醒、确认回执（触发自动记账）
- 依赖：引用 "user".users；与 expense 通过应用层交互（自动记账）
- 实体
  - jobs：任务定义
  - job_runs：周期实例（期次/窗口）
  - reminders：提醒记录
  - confirmations：用户确认回执

## 2. 数据字典
（字段说明补充）

- scheduler.jobs 字段说明
  - id：任务ID，自增主键
  - user_id：所属用户ID，引用 "user".users(id)
  - name：任务名称
  - description：任务说明/备注
  - rule：调度规则（如 cron 表达式或周期JSON）
  - first_run_at：首次执行时间（UTC）
  - advance_minutes：提前提醒分钟数
  - channel：通知渠道（默认 telegram）
  - status：任务状态（active/paused/archived）
  - created_at/updated_at：审计时间（UTC）

- scheduler.job_runs 字段说明
  - id：运行实例ID
  - job_id：关联任务ID，引用 scheduler.jobs(id)
  - period_key：周期键（如 2025-01）
  - scheduled_at：计划执行时间（UTC）
  - sent_at：提醒发送时间（UTC）
  - status：实例状态（pending/sent/confirmed/skipped/snoozed/cancelled）
  - created_at/updated_at：审计时间（UTC）
  - 唯一：(job_id, period_key)：同一任务在一个周期仅一条实例

- scheduler.reminders 字段说明
  - id：提醒记录ID
  - job_run_id：关联运行实例ID，引用 scheduler.job_runs(id)
  - sent_at：提醒发送时间（UTC）
  - payload：发送内容快照（按钮、文案等）
  - created_at/updated_at：审计时间（UTC）

- scheduler.confirmations 字段说明
  - id：回执记录ID
  - job_run_id：关联运行实例ID，引用 scheduler.job_runs(id)
  - action：用户动作（complete/skip/snooze/cancel）
  - confirmed_at：用户确认时间（UTC）
  - idempotency_key：幂等键（用于防止重复记账）
  - payload：回执上下文（如交互参数）
  - created_at/updated_at：审计时间（UTC）
  - 唯一：(job_run_id, idempotency_key)：运行实例内幂等唯一
- scheduler.jobs
  - id | BIGINT PK
  - user_id | BIGINT FK "user".users(id)
  - name | TEXT NOT NULL
  - description | TEXT NULL
  - rule | TEXT NOT NULL（如 cron/periodic JSON）
  - first_run_at | TIMESTAMPTZ NOT NULL
  - advance_minutes | INT NOT NULL DEFAULT 0
  - channel | TEXT NOT NULL DEFAULT 'telegram'
  - status | TEXT NOT NULL（active/paused/archived）
  - created_at/updated_at | TIMESTAMPTZ

- scheduler.job_runs
  - id | BIGINT PK
  - job_id | BIGINT FK scheduler.jobs(id)
  - period_key | TEXT NOT NULL（如 2025-01）
  - scheduled_at | TIMESTAMPTZ NOT NULL
  - sent_at | TIMESTAMPTZ NULL
  - status | TEXT NOT NULL（pending/sent/confirmed/skipped/snoozed/cancelled）
  - created_at/updated_at | TIMESTAMPTZ
  - 唯一：(job_id, period_key)

- scheduler.reminders
  - id | BIGINT PK
  - job_run_id | BIGINT FK scheduler.job_runs(id)
  - sent_at | TIMESTAMPTZ NOT NULL
  - payload | JSONB NULL
  - created_at/updated_at | TIMESTAMPTZ

- scheduler.confirmations
  - id | BIGINT PK
  - job_run_id | BIGINT FK scheduler.job_runs(id)
  - action | TEXT NOT NULL（complete/skip/snooze/cancel）
  - confirmed_at | TIMESTAMPTZ NOT NULL
  - idempotency_key | TEXT NOT NULL
  - payload | JSONB NULL
  - created_at/updated_at | TIMESTAMPTZ
  - 唯一：(job_run_id, idempotency_key)

## 3. DDL（可执行）
```sql
CREATE SCHEMA IF NOT EXISTS scheduler;

CREATE OR REPLACE FUNCTION scheduler.tg_set_updated_at()
RETURNS trigger LANGUAGE plpgsql AS $$
BEGIN NEW.updated_at := now(); RETURN NEW; END $$;

CREATE TABLE IF NOT EXISTS scheduler.jobs (
  id              BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id         BIGINT NOT NULL REFERENCES "user".users(id) ON DELETE RESTRICT,
  name            TEXT   NOT NULL,
  description     TEXT   NULL,
  rule            TEXT   NOT NULL,
  first_run_at    TIMESTAMPTZ NOT NULL,
  advance_minutes INT    NOT NULL DEFAULT 0,
  channel         TEXT   NOT NULL DEFAULT 'telegram',
  status          TEXT   NOT NULL DEFAULT 'active',
  created_at      TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at      TIMESTAMPTZ NOT NULL DEFAULT now(),
  CONSTRAINT ck_jobs__status CHECK (status IN ('active','paused','archived')),
  CONSTRAINT ck_jobs__advance CHECK (advance_minutes BETWEEN 0 AND 10080)
);

CREATE INDEX IF NOT EXISTS idx_jobs__user_id ON scheduler.jobs(user_id);

CREATE TRIGGER trg_jobs__upd
BEFORE UPDATE ON scheduler.jobs
FOR EACH ROW EXECUTE FUNCTION scheduler.tg_set_updated_at();

CREATE TABLE IF NOT EXISTS scheduler.job_runs (
  id            BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  job_id        BIGINT NOT NULL REFERENCES scheduler.jobs(id) ON DELETE CASCADE,
  period_key    TEXT   NOT NULL,
  scheduled_at  TIMESTAMPTZ NOT NULL,
  sent_at       TIMESTAMPTZ NULL,
  status        TEXT   NOT NULL DEFAULT 'pending',
  created_at    TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at    TIMESTAMPTZ NOT NULL DEFAULT now(),
  CONSTRAINT uq_job_runs__job_period UNIQUE (job_id, period_key),
  CONSTRAINT ck_job_runs__status CHECK (status IN ('pending','sent','confirmed','skipped','snoozed','cancelled'))
) PARTITION BY RANGE (scheduled_at);

-- 示例月分区：
-- CREATE TABLE scheduler.job_runs_2025_01 PARTITION OF scheduler.job_runs
-- FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');

CREATE INDEX IF NOT EXISTS idx_job_runs__job_scheduled
ON ONLY scheduler.job_runs (job_id, scheduled_at);

CREATE TRIGGER trg_job_runs__upd
BEFORE UPDATE ON scheduler.job_runs
FOR EACH ROW EXECUTE FUNCTION scheduler.tg_set_updated_at();

CREATE TABLE IF NOT EXISTS scheduler.reminders (
  id         BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  job_run_id BIGINT NOT NULL REFERENCES scheduler.job_runs(id) ON DELETE CASCADE,
  sent_at    TIMESTAMPTZ NOT NULL,
  payload    JSONB NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TRIGGER trg_reminders__upd
BEFORE UPDATE ON scheduler.reminders
FOR EACH ROW EXECUTE FUNCTION scheduler.tg_set_updated_at();

CREATE TABLE IF NOT EXISTS scheduler.confirmations (
  id               BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  job_run_id       BIGINT NOT NULL REFERENCES scheduler.job_runs(id) ON DELETE CASCADE,
  action           TEXT   NOT NULL,
  confirmed_at     TIMESTAMPTZ NOT NULL,
  idempotency_key  TEXT   NOT NULL,
  payload          JSONB  NULL,
  created_at       TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at       TIMESTAMPTZ NOT NULL DEFAULT now(),
  CONSTRAINT ck_confirmations__action CHECK (action IN ('complete','skip','snooze','cancel')),
  CONSTRAINT uq_confirmations__run_idem UNIQUE (job_run_id, idempotency_key)
);

CREATE INDEX IF NOT EXISTS idx_confirmations__run_confirmed
ON scheduler.confirmations (job_run_id, confirmed_at DESC);

CREATE TRIGGER trg_confirmations__upd
BEFORE UPDATE ON scheduler.confirmations
FOR EACH ROW EXECUTE FUNCTION scheduler.tg_set_updated_at();

-- 种子
INSERT INTO scheduler.jobs(user_id, name, rule, first_run_at)
VALUES (1, 'YouTube 订阅', 'cron: 0 10 1 * *', now())
ON CONFLICT DO NOTHING;

INSERT INTO scheduler.job_runs(job_id, period_key, scheduled_at)
SELECT j.id, to_char(now(), 'YYYY-MM'), date_trunc('month', now())
FROM scheduler.jobs j
LIMIT 1;

INSERT INTO scheduler.reminders(job_run_id, sent_at)
SELECT r.id, now() FROM scheduler.job_runs r
LIMIT 1;
```

## 4. 一致性与幂等
- job_runs 唯一键 (job_id, period_key) 确保每周期仅一实例
- confirmations 唯一键 (job_run_id, idempotency_key) 控制回执幂等

## 5. 典型查询与性能
```sql
-- 拉取到期未发送的 job_runs
SELECT id, job_id, scheduled_at
FROM scheduler.job_runs
WHERE status = 'pending' AND scheduled_at <= now()
ORDER BY scheduled_at
LIMIT 100;
```
- 性能：job_id+scheduled_at 索引；按月分区裁剪

## 6. 权限与安全
- 以 user_id 为边界的授权；RLS 可在应用层实现

## 7. 历史与时间序列
- job_runs 按月分区；旧实例归档或清理

## 8. 视图与物化视图（可选）
- 可提供“即将到期任务”视图供 Bot 查询

## 9. 迁移与回滚
- V1.1 增加 channel/status 值；V1.2 引入分区
- 回滚：先删索引、触发器，再回退表结构

## 10. 测试与数据校验
- 测试：period_key 唯一冲突、确认幂等键冲突、状态流转
- 校验：action 合法性、advance_minutes 范围

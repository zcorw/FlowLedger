# Currency 模块 SQL 说明书

## 1. 模块范围与实体清单
- 职责：维护货币清单与历史汇率，提供统一换算基础数据
- 依赖：被所有业务模块查询；与外部汇率源同步
- 实体
  - currencies：可用货币清单
  - exchange_rates：历史汇率（基准/报价/日期）

## 2. 数据字典
（字段说明补充）

- currency.currencies 字段说明
  - code：货币代码（ISO 4217），主键
  - name：货币中文/英文名称
  - symbol：货币符号，如 $/¥
  - scale：显示小数位（0–6），用于前端格式化
  - created_at/updated_at：审计时间（UTC）

- currency.exchange_rates 字段说明
  - id：自增主键
  - base_code：基准货币代码，引用 currencies(code)
  - quote_code：报价货币代码，引用 currencies(code)
  - rate_date：汇率对应的自然日（UTC）
  - rate：当日汇率（NUMERIC(20,10)）
  - source：数据来源（供应商标识）
  - created_at/updated_at：审计时间（UTC）
  - 唯一：(base_code, quote_code, rate_date)：同日同币对唯一
- currency.currencies
  - code | TEXT PK | 货币代码（ISO） | 示例：USD
  - name | TEXT NOT NULL | 名称 | 示例：US Dollar
  - symbol | TEXT NULL | 符号 | 示例：$
  - scale | INT NOT NULL DEFAULT 2 | 显示小数位
  - created_at/updated_at | TIMESTAMPTZ | 审计

- currency.exchange_rates
  - id | BIGINT PK | 识别符
  - base_code/quote_code | TEXT FK currencies(code)
  - rate_date | DATE NOT NULL | 交易日（UTC 日粒度）
  - rate | NUMERIC(20,10) NOT NULL | >0
  - source | TEXT NULL | 数据来源
  - created_at/updated_at | TIMESTAMPTZ | 审计
  - 约束：uq (base_code, quote_code, rate_date) 唯一；ck rate>0

## 3. DDL（可执行）
```sql
CREATE SCHEMA IF NOT EXISTS currency;

-- 触发器（可选）
CREATE OR REPLACE FUNCTION currency.tg_set_updated_at()
RETURNS trigger LANGUAGE plpgsql AS $$
BEGIN NEW.updated_at := now(); RETURN NEW; END $$;

CREATE TABLE IF NOT EXISTS currency.currencies (
  code        TEXT PRIMARY KEY,
  name        TEXT NOT NULL,
  symbol      TEXT NULL,
  scale       INT  NOT NULL DEFAULT 2,
  created_at  TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at  TIMESTAMPTZ NOT NULL DEFAULT now(),
  CONSTRAINT ck_currencies__scale CHECK (scale BETWEEN 0 AND 6)
);

CREATE TRIGGER trg_currencies__upd
BEFORE UPDATE ON currency.currencies
FOR EACH ROW EXECUTE FUNCTION currency.tg_set_updated_at();

CREATE TABLE IF NOT EXISTS currency.exchange_rates (
  id          BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  base_code   TEXT NOT NULL REFERENCES currency.currencies(code) ON DELETE RESTRICT,
  quote_code  TEXT NOT NULL REFERENCES currency.currencies(code) ON DELETE RESTRICT,
  rate_date   DATE NOT NULL,
  rate        NUMERIC(20,10) NOT NULL,
  source      TEXT NULL,
  created_at  TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at  TIMESTAMPTZ NOT NULL DEFAULT now(),
  CONSTRAINT uq_exchange_rates__pair_date UNIQUE (base_code, quote_code, rate_date),
  CONSTRAINT ck_exchange_rates__positive CHECK (rate > 0),
  CONSTRAINT ck_exchange_rates__not_same CHECK (base_code <> quote_code)
);

CREATE TRIGGER trg_exchange_rates__upd
BEFORE UPDATE ON currency.exchange_rates
FOR EACH ROW EXECUTE FUNCTION currency.tg_set_updated_at();

CREATE INDEX IF NOT EXISTS idx_exchange_rates__pair_date_desc
ON currency.exchange_rates (base_code, quote_code, rate_date DESC);

-- 可选：按月分区示例
-- CREATE TABLE currency.exchange_rates_y2025m01 PARTITION OF currency.exchange_rates
-- FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');

-- 种子数据
INSERT INTO currency.currencies(code, name, symbol, scale)
VALUES ('USD','US Dollar','$',2)
ON CONFLICT (code) DO NOTHING;

INSERT INTO currency.currencies(code, name, symbol, scale)
VALUES ('CNY','Chinese Yuan','¥',2)
ON CONFLICT (code) DO NOTHING;

INSERT INTO currency.exchange_rates(base_code, quote_code, rate_date, rate, source)
VALUES ('USD','CNY','2025-01-01',7.1000000000,'seed')
ON CONFLICT DO NOTHING;
```

## 4. 一致性与幂等
- 唯一键：base_code+quote_code+rate_date 唯一，去重同日多条
- 幂等写入：同键 `INSERT ... ON CONFLICT DO UPDATE` 更新来源或标记

## 5. 典型查询与性能
- 查询指定日汇率（带回退到最近之前一天）
```sql
SELECT r1.*
FROM currency.exchange_rates r1
WHERE r1.base_code = 'USD' AND r1.quote_code = 'CNY'
  AND r1.rate_date = (
    SELECT max(rate_date) FROM currency.exchange_rates r2
    WHERE r2.base_code = r1.base_code AND r2.quote_code = r1.quote_code
      AND r2.rate_date <= DATE '2025-01-15'
  );
```
- 维护：月度分区（可选）、定期 VACUUM/ANALYZE；pair+date 索引覆盖

## 6. 权限与安全
- 角色：app_reader（SELECT）、app_writer（INSERT/UPDATE）、app_admin（DDL）
- 此模块无需 RLS；外部访问通过最小权限角色

## 7. 历史与时间序列
- 保留全量历史；report.mv_fx_daily 物化视图做日级聚合与缓存

## 8. 视图与物化视图（可选）
- 已在顶层文件提供示例

## 9. 迁移与回滚
- V1.1 新增来源列默认 NULL；V1.2 增加分区表
- 回滚：删除新增列或分区表；注意先删除依赖索引/触发器

## 10. 测试与数据校验
- 校验：rate>0、base<>quote、唯一键冲突
- 用例：重复插入同日汇率应更新或忽略；不存在日自动回退查询结果

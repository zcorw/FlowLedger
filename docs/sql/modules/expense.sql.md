# Expense 模块 SQL 说明
## 1. 模块范围
- 责任：消费记录与分类管理
- 依赖：引用 `"user".users`、`currency.currencies`、`deposit.institutions`（可选，作为支付机构外键）
- 实体：`expense_categories`（分类，支持父子关系）、`expenses`（消费流水）

## 2. 字段概览
- `expense.expense_categories`
  - `id` BIGINT PK，`user_id` BIGINT FK `"user".users(id)`，`name` TEXT，`parent_id` BIGINT 可空 FK `expense_categories(id)`，`created_at/updated_at`
  - 唯一约束：(`user_id`,`name`)
- `expense.expenses`
  - `id` BIGINT PK，`user_id` BIGINT FK `"user".users(id)`，`amount` NUMERIC(20,6) NOT NULL（>=0），`currency` TEXT FK `currency.currencies(code)`，`category_id` BIGINT 可空 FK `expense.expense_categories(id)`，`merchant` TEXT，可选 `tags` TEXT[]，`paid_account_id` BIGINT 可空 FK `deposit.institutions(id)`，`occurred_at` TIMESTAMPTZ，`source_ref` TEXT 可空（部分唯一），`note` TEXT，`created_at/updated_at`
  - 部分唯一：(`user_id`,`source_ref`) WHERE source_ref IS NOT NULL

## 3. 主要 DDL
```sql
CREATE SCHEMA IF NOT EXISTS expense;

CREATE OR REPLACE FUNCTION expense.tg_set_updated_at()
RETURNS trigger LANGUAGE plpgsql AS $$
BEGIN NEW.updated_at := now(); RETURN NEW; END $$;

CREATE TABLE IF NOT EXISTS expense.expense_categories (
  id         BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id    BIGINT NOT NULL REFERENCES "user".users(id) ON DELETE CASCADE,
  name       TEXT NOT NULL,
  parent_id  BIGINT NULL REFERENCES expense.expense_categories(id) ON DELETE SET NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  CONSTRAINT uq_expense_categories__user_name UNIQUE (user_id, name)
);
CREATE TRIGGER trg_expense_categories__upd
BEFORE UPDATE ON expense.expense_categories
FOR EACH ROW EXECUTE FUNCTION expense.tg_set_updated_at();

CREATE TABLE IF NOT EXISTS expense.expenses (
  id              BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id         BIGINT NOT NULL REFERENCES "user".users(id) ON DELETE RESTRICT,
  amount          NUMERIC(20,6) NOT NULL,
  currency        TEXT   NOT NULL REFERENCES currency.currencies(code) ON DELETE RESTRICT,
  category_id     BIGINT NULL REFERENCES expense.expense_categories(id) ON DELETE SET NULL,
  merchant        TEXT   NULL,
  tags            TEXT[] NULL,
  paid_account_id BIGINT NULL REFERENCES deposit.institutions(id) ON DELETE SET NULL,
  occurred_at     TIMESTAMPTZ NOT NULL,
  source_ref      TEXT   NULL,
  note            TEXT   NULL,
  created_at      TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at      TIMESTAMPTZ NOT NULL DEFAULT now(),
  CONSTRAINT ck_expenses__amount_positive CHECK (amount >= 0)
);
CREATE TRIGGER trg_expenses__upd
BEFORE UPDATE ON expense.expenses
FOR EACH ROW EXECUTE FUNCTION expense.tg_set_updated_at();

CREATE UNIQUE INDEX IF NOT EXISTS idx_expenses__user_source_ref
ON expense.expenses (user_id, source_ref)
WHERE source_ref IS NOT NULL;

CREATE INDEX IF NOT EXISTS idx_expenses__user_occurred_at_desc
ON expense.expenses (user_id, occurred_at DESC);

-- 种子数据示例
INSERT INTO expense.expense_categories(user_id, name) VALUES (1,'订阅')
ON CONFLICT DO NOTHING;

INSERT INTO expense.expenses(user_id, amount, currency, category_id, merchant, occurred_at, note)
SELECT 1, 11.990000, 'USD', c.id, 'YouTube', now(), '会员订阅'
FROM expense.expense_categories c WHERE c.user_id=1 AND c.name='订阅'
LIMIT 1;
```

## 4. 幂等与约束
- `source_ref` 用于外部导入的幂等键（同一用户 + 来源键唯一）；为空时由业务侧自行保证不重复。
- 金额非负，分类同用户内唯一；删除用户时级联删除其分类和消费。
- `paid_account_id` 可为空，指向机构，删除机构时置空。

## 5. 示例查询
```sql
-- 按月汇总分类支出
SELECT date_trunc('month', occurred_at) AS month,
       category_id,
       sum(amount) AS total_amount
FROM expense.expenses
WHERE user_id = $1
GROUP BY 1,2
ORDER BY 1 DESC;
```

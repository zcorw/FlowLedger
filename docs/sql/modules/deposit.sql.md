# Deposit 模块 SQL 说明书

## 1. 模块范围与实体清单
- 职责：机构、账户、余额时间序列
- 依赖：引用 "user".users、currency.currencies
- 实体
  - institutions：金融机构
  - accounts：用户账户
  - account_balances：账户余额时间序列

## 2. 数据字典
（字段说明补充）

- deposit.institutions 字段说明
  - id：机构ID，自增主键
  - name：机构名称（唯一）
  - type：机构类型（bank/broker/other）
  - created_at/updated_at：审计时间（UTC）

- deposit.accounts 字段说明
  - id：账户ID，自增主键
  - user_id：所属用户ID
  - institution_id：所属机构ID
  - currency：账户主货币代码
  - status：账户状态（active/inactive）
  - created_at/updated_at：审计时间（UTC）

- deposit.account_balances 字段说明
  - id：余额快照ID，自增主键
  - account_id：关联账户ID
  - amount：余额金额（NUMERIC(20,6)）
  - as_of：快照时间（UTC）
  - created_at/updated_at：审计时间（UTC）
  - 唯一：(account_id, as_of)：同一时间点同一账户仅一条记录
- deposit.institutions
  - id | BIGINT PK
  - name | TEXT NOT NULL UNIQUE
  - type | TEXT NOT NULL（bank/broker/other）
  - created_at/updated_at | TIMESTAMPTZ

- deposit.accounts
  - id | BIGINT PK
  - user_id | BIGINT FK "user".users(id)
  - institution_id | BIGINT FK deposit.institutions(id)
  - currency | TEXT FK currency.currencies(code)
  - status | TEXT NOT NULL（active/inactive）
  - created_at/updated_at | TIMESTAMPTZ

- deposit.account_balances
  - id | BIGINT PK
  - account_id | BIGINT FK deposit.accounts(id)
  - amount | NUMERIC(20,6) NOT NULL
  - as_of | TIMESTAMPTZ NOT NULL（UTC）
  - created_at/updated_at | TIMESTAMPTZ
  - 唯一：(account_id, as_of)

## 3. DDL（可执行）
```sql
CREATE SCHEMA IF NOT EXISTS deposit;

CREATE OR REPLACE FUNCTION deposit.tg_set_updated_at()
RETURNS trigger LANGUAGE plpgsql AS $$
BEGIN NEW.updated_at := now(); RETURN NEW; END $$;

CREATE TABLE IF NOT EXISTS deposit.institutions (
  id         BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name       TEXT NOT NULL UNIQUE,
  type       TEXT NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  CONSTRAINT ck_institutions__type CHECK (type IN ('bank','broker','other'))
);

CREATE TRIGGER trg_institutions__upd
BEFORE UPDATE ON deposit.institutions
FOR EACH ROW EXECUTE FUNCTION deposit.tg_set_updated_at();

CREATE TABLE IF NOT EXISTS deposit.accounts (
  id              BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id         BIGINT NOT NULL REFERENCES "user".users(id) ON DELETE RESTRICT,
  institution_id  BIGINT NOT NULL REFERENCES deposit.institutions(id) ON DELETE RESTRICT,
  currency        TEXT   NOT NULL REFERENCES currency.currencies(code) ON DELETE RESTRICT,
  status          TEXT   NOT NULL DEFAULT 'active',
  created_at      TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at      TIMESTAMPTZ NOT NULL DEFAULT now(),
  CONSTRAINT ck_accounts__status CHECK (status IN ('active','inactive'))
);

CREATE INDEX IF NOT EXISTS idx_accounts__user_id ON deposit.accounts(user_id);
CREATE INDEX IF NOT EXISTS idx_accounts__institution_id ON deposit.accounts(institution_id);

CREATE TRIGGER trg_accounts__upd
BEFORE UPDATE ON deposit.accounts
FOR EACH ROW EXECUTE FUNCTION deposit.tg_set_updated_at();

CREATE TABLE IF NOT EXISTS deposit.account_balances (
  id         BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  account_id BIGINT NOT NULL REFERENCES deposit.accounts(id) ON DELETE CASCADE,
  amount     NUMERIC(20,6) NOT NULL,
  as_of      TIMESTAMPTZ NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  CONSTRAINT uq_account_balances__account_asof UNIQUE (account_id, as_of),
  CONSTRAINT ck_account_balances__amount_nonneg CHECK (amount >= 0)
) PARTITION BY RANGE (as_of);

-- 示例：创建一个月分区
-- CREATE TABLE deposit.account_balances_2025_01 PARTITION OF deposit.account_balances
-- FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');

CREATE INDEX IF NOT EXISTS idx_account_balances__as_of_desc
ON ONLY deposit.account_balances (as_of DESC);

CREATE TRIGGER trg_account_balances__upd
BEFORE UPDATE ON deposit.account_balances
FOR EACH ROW EXECUTE FUNCTION deposit.tg_set_updated_at();

-- 种子
INSERT INTO deposit.institutions(name, type) VALUES ('Example Bank','bank')
ON CONFLICT (name) DO NOTHING;

INSERT INTO deposit.accounts(user_id, institution_id, currency)
SELECT 1, i.id, 'USD' FROM deposit.institutions i WHERE i.name='Example Bank'
ON CONFLICT DO NOTHING;

INSERT INTO deposit.account_balances(account_id, amount, as_of)
SELECT a.id, 1000.00, now() FROM deposit.accounts a
LIMIT 1;
```

## 4. 一致性与幂等
- 唯一：(account_id, as_of) 防止重复快照
- 幂等：基于唯一键进行 UPSERT

## 5. 典型查询与性能
```sql
-- 查询某用户最新各账户余额
SELECT a.id AS account_id, ab.amount, ab.as_of
FROM deposit.accounts a
JOIN LATERAL (
  SELECT amount, as_of
  FROM deposit.account_balances ab
  WHERE ab.account_id = a.id
  ORDER BY as_of DESC
  LIMIT 1
) ab ON true
WHERE a.user_id = $1;
```
- 性能：as_of DESC 索引/分区裁剪；定期 VACUUM/ANALYZE

## 6. 权限与安全
- 外键 RESTRICT，balances 对 accounts CASCADE（账户删除清理余额）

## 7. 历史与时间序列
- 按月分区；归档老分区至冷存储或 report schema

## 8. 视图与物化视图（可选）
- 可提供账户最新余额视图，便于报表 JOIN

## 9. 迁移与回滚
- V1.1 新增 status；V1.2 引入分区
- 回滚注意顺序：先删除分区再删主表或索引

## 10. 测试与数据校验
- 唯一性与金额非负检查；外键删除行为验证

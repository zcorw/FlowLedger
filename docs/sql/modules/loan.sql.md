# Loan 模块 SQL 说明书

## 1. 模块范围与实体清单
- 职责：借贷合同、还款计划、还款流水
- 依赖：引用 "user".users、currency.currencies
- 实体
  - counterparties：交易对手（机构/个人）
  - loans：借贷合同
  - loan_schedules：还款计划
  - loan_txns：还款记录

## 2. 数据字典
（字段说明补充）

- loan.counterparties 字段说明
  - id：交易对手ID，自增主键
  - name：名称（唯一）
  - type：类型（institution/person）
  - created_at/updated_at：审计时间（UTC）

- loan.loans 字段说明
  - id：贷款合同ID，自增主键
  - user_id：所属用户ID
  - counterparty_id：交易对手ID
  - principal：本金（NUMERIC(20,6)）
  - currency：币种（引用 currency.currencies）
  - rate_type：利率类型（fixed/floating）
  - rate_value：利率数值（NUMERIC(20,10)）
  - term_months：期数（月）
  - start_date：合同起始日期时间（UTC）
  - status：状态（active/closed/defaulted）
  - created_at/updated_at：审计时间（UTC）

- loan.loan_schedules 字段说明
  - id：计划ID，自增主键
  - loan_id：关联贷款ID
  - period_no：期次序号（唯一与 loan_id 组合）
  - due_date：到期时间（UTC）
  - principal_due：当期应还本金
  - interest_due：当期应还利息
  - created_at/updated_at：审计时间（UTC）
  - 唯一：(loan_id, period_no)：每期唯一

- loan.loan_txns 字段说明
  - id：还款记录ID，自增主键
  - loan_id：关联贷款ID
  - period_no：对应期次（可空；允许非计划外还款）
  - paid_at：实际还款时间（UTC）
  - principal_paid：实还本金
  - interest_paid：实还利息
  - fee_paid：费用（如手续费）
  - created_at/updated_at：审计时间（UTC）
- loan.counterparties
  - id | BIGINT PK
  - name | TEXT NOT NULL
  - type | TEXT NOT NULL（institution/person）
  - created_at/updated_at | TIMESTAMPTZ

- loan.loans
  - id | BIGINT PK
  - user_id | BIGINT FK "user".users(id)
  - counterparty_id | BIGINT FK loan.counterparties(id)
  - principal | NUMERIC(20,6) NOT NULL
  - currency | TEXT FK currency.currencies(code)
  - rate_type | TEXT NOT NULL（fixed/floating）
  - rate_value | NUMERIC(20,10) NOT NULL
  - term_months | INT NOT NULL
  - start_date | TIMESTAMPTZ NOT NULL
  - status | TEXT NOT NULL（active/closed/defaulted）
  - created_at/updated_at | TIMESTAMPTZ
  - 检查：金额非负、利率>=0、term>0

- loan.loan_schedules
  - id | BIGINT PK
  - loan_id | BIGINT FK loan.loans(id)
  - period_no | INT NOT NULL
  - due_date | TIMESTAMPTZ NOT NULL
  - principal_due | NUMERIC(20,6) NOT NULL
  - interest_due | NUMERIC(20,6) NOT NULL
  - created_at/updated_at | TIMESTAMPTZ
  - 唯一：(loan_id, period_no)

- loan.loan_txns
  - id | BIGINT PK
  - loan_id | BIGINT FK loan.loans(id)
  - period_no | INT NULL
  - paid_at | TIMESTAMPTZ NOT NULL
  - principal_paid | NUMERIC(20,6) NOT NULL DEFAULT 0
  - interest_paid | NUMERIC(20,6) NOT NULL DEFAULT 0
  - fee_paid | NUMERIC(20,6) NOT NULL DEFAULT 0
  - created_at/updated_at | TIMESTAMPTZ

## 3. DDL（可执行）
```sql
CREATE SCHEMA IF NOT EXISTS loan;

CREATE OR REPLACE FUNCTION loan.tg_set_updated_at()
RETURNS trigger LANGUAGE plpgsql AS $$
BEGIN NEW.updated_at := now(); RETURN NEW; END $$;

CREATE TABLE IF NOT EXISTS loan.counterparties (
  id         BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name       TEXT NOT NULL,
  type       TEXT NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  CONSTRAINT ck_counterparties__type CHECK (type IN ('institution','person')),
  CONSTRAINT uq_counterparties__name UNIQUE (name)
);

CREATE TRIGGER trg_counterparties__upd
BEFORE UPDATE ON loan.counterparties
FOR EACH ROW EXECUTE FUNCTION loan.tg_set_updated_at();

CREATE TABLE IF NOT EXISTS loan.loans (
  id              BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id         BIGINT NOT NULL REFERENCES "user".users(id) ON DELETE RESTRICT,
  counterparty_id BIGINT NOT NULL REFERENCES loan.counterparties(id) ON DELETE RESTRICT,
  principal       NUMERIC(20,6) NOT NULL,
  currency        TEXT   NOT NULL REFERENCES currency.currencies(code) ON DELETE RESTRICT,
  rate_type       TEXT   NOT NULL,
  rate_value      NUMERIC(20,10) NOT NULL,
  term_months     INT    NOT NULL,
  start_date      TIMESTAMPTZ NOT NULL,
  status          TEXT   NOT NULL DEFAULT 'active',
  created_at      TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at      TIMESTAMPTZ NOT NULL DEFAULT now(),
  CONSTRAINT ck_loans__principal_nonneg CHECK (principal >= 0),
  CONSTRAINT ck_loans__rate_nonneg CHECK (rate_value >= 0),
  CONSTRAINT ck_loans__term_pos CHECK (term_months > 0),
  CONSTRAINT ck_loans__rate_type CHECK (rate_type IN ('fixed','floating')),
  CONSTRAINT ck_loans__status CHECK (status IN ('active','closed','defaulted'))
);

CREATE INDEX IF NOT EXISTS idx_loans__user_id ON loan.loans(user_id);

CREATE TRIGGER trg_loans__upd
BEFORE UPDATE ON loan.loans
FOR EACH ROW EXECUTE FUNCTION loan.tg_set_updated_at();

CREATE TABLE IF NOT EXISTS loan.loan_schedules (
  id             BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  loan_id        BIGINT NOT NULL REFERENCES loan.loans(id) ON DELETE CASCADE,
  period_no      INT    NOT NULL,
  due_date       TIMESTAMPTZ NOT NULL,
  principal_due  NUMERIC(20,6) NOT NULL,
  interest_due   NUMERIC(20,6) NOT NULL,
  created_at     TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at     TIMESTAMPTZ NOT NULL DEFAULT now(),
  CONSTRAINT uq_loan_schedules__loan_period UNIQUE (loan_id, period_no),
  CONSTRAINT ck_loan_schedules__principal_nonneg CHECK (principal_due >= 0),
  CONSTRAINT ck_loan_schedules__interest_nonneg CHECK (interest_due >= 0)
);

CREATE INDEX IF NOT EXISTS idx_loan_schedules__due_date
ON loan.loan_schedules (due_date);

CREATE TRIGGER trg_loan_schedules__upd
BEFORE UPDATE ON loan.loan_schedules
FOR EACH ROW EXECUTE FUNCTION loan.tg_set_updated_at();

CREATE TABLE IF NOT EXISTS loan.loan_txns (
  id             BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  loan_id        BIGINT NOT NULL REFERENCES loan.loans(id) ON DELETE RESTRICT,
  period_no      INT NULL,
  paid_at        TIMESTAMPTZ NOT NULL,
  principal_paid NUMERIC(20,6) NOT NULL DEFAULT 0,
  interest_paid  NUMERIC(20,6) NOT NULL DEFAULT 0,
  fee_paid       NUMERIC(20,6) NOT NULL DEFAULT 0,
  created_at     TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at     TIMESTAMPTZ NOT NULL DEFAULT now()
) PARTITION BY RANGE (paid_at);

-- 示例月分区：
-- CREATE TABLE loan.loan_txns_2025_01 PARTITION OF loan.loan_txns
-- FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');

CREATE INDEX IF NOT EXISTS idx_loan_txns__loan_paid_at
ON ONLY loan.loan_txns (loan_id, paid_at DESC);

CREATE TRIGGER trg_loan_txns__upd
BEFORE UPDATE ON loan.loan_txns
FOR EACH ROW EXECUTE FUNCTION loan.tg_set_updated_at();

-- 种子
INSERT INTO loan.counterparties(name, type) VALUES ('Example Lender','institution')
ON CONFLICT DO NOTHING;

INSERT INTO loan.loans(user_id, counterparty_id, principal, currency, rate_type, rate_value, term_months, start_date)
SELECT 1, c.id, 10000.00, 'USD', 'fixed', 0.0500000000, 12, now()
FROM loan.counterparties c WHERE c.name='Example Lender'
ON CONFLICT DO NOTHING;

INSERT INTO loan.loan_schedules(loan_id, period_no, due_date, principal_due, interest_due)
SELECT l.id, 1, now() + interval '30 days', 800.00, 50.00
FROM loan.loans l LIMIT 1;
```

## 4. 一致性与幂等
- 唯一：(loan_id, period_no) 保证计划唯一；txns 不与计划重复
- 幂等：对 loan_txns 可按 (loan_id, period_no, paid_at) 定义业务幂等键（实际实现用 upsert）

## 5. 典型查询与性能
```sql
-- 查询贷款余额（简化：计划-已还）
SELECT l.id AS loan_id,
       sum(s.principal_due) - coalesce(sum(t.principal_paid),0) AS principal_outstanding
FROM loan.loans l
LEFT JOIN loan.loan_schedules s ON s.loan_id = l.id
LEFT JOIN loan.loan_txns t ON t.loan_id = l.id AND t.period_no = s.period_no
WHERE l.id = $1
GROUP BY l.id;
```
- 性能：loan_id、due_date、paid_at 索引；分区裁剪

## 6. 权限与安全
- 删除行为：schedules 对 loans 级联（合同删除清理计划）

## 7. 历史与时间序列
- loan_txns 按月分区；归档老分区

## 8. 视图与物化视图（可选）
- 可提供逾期统计视图（对比 due_date 与 paid_at）

## 9. 迁移与回滚
- V1.1 增加 fee_paid；V1.2 rate_type 新值（ENUM→CHECK 便于演进）
- 回滚：先删依赖索引，再删列/约束

## 10. 测试与数据校验
- 约束触发：金额非负；状态值；外键引用
- 用例：重复 period_no 写入触发唯一冲突

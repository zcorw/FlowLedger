# 收据上传（OCR）自动生成消费记录

本指南说明如何通过 Telegram 向机器人上传收据（照片/图片/PDF），由系统自动解析并生成消费记录草稿，最终经你确认入库。

## 用户如何操作

- 发送收据图片或 PDF
  - 直接把收据“照片/截图/扫描件”发送给机器人；
  - 或以“文件”形式发送清晰图片/PDF（推荐电子小票用 PDF）。
- 可选：在图片“说明/Caption”中补充提示
  - 示例：`#food 星巴克 @2025-11-01 08:30` 或 `35.8 CNY #coffee 星巴克`；
  - 支持 `#分类`、备注/商户名、金额/币种、日期时间等提示。
- 机器人回显解析结果供确认
  - 自动提取：金额、币种（符号或文本）、日期时间、商户；
  - 若检测到多笔候选金额（小计/税/合计），默认选择“合计/应付”；
  - 通过内联按钮逐项编辑：“金额/币种/时间/分类/备注/账户”；
  - 确认后写入；也可放弃或改为手动录入。

## 示例对话

1) 你发送一张咖啡店小票照片（Caption：`#coffee 星巴克 @2025-11-01 08:30`）。
2) 机器人回应：
   - 检测金额：`35.80`，币种：`CNY`，时间：`2025-11-01 08:30 Asia/Shanghai`；
   - 候选分类：`#coffee`；备注：`星巴克`；
   - 按钮：编辑金额/币种/时间/分类/备注 | 确认 | 取消。
3) 你点击“确认”，返回记录编号并提示撤销方式 `/undo`。

## 识别效果与建议

- 光线充足、避免反光与遮挡；尽量让票据充满画面；
- 使用“文档模式/扫描模式”拍摄；
- PDF 或高分辨率图片优先（边长≥1280px）。

## 常见问题

- 检测到多金额：确认卡片会展示若干候选，选择后继续；
- 币种无法识别：按默认货币填充并提示你选择；
- 时间缺失/歧义：按用户时区的当前时间，或提示你选择日期时间；
- OCR 失败：会请你补充金额/币种/时间再确认，或改用文本指令 `/expense add ...`。

## 隐私与安全

- 默认仅保存结构化字段；原始图片短期留存后自动删除（例如 24 小时内）；
- 你可以选择“随记录保存收据原图”，用于后续核对；
- 传输与存储遵循最小化与 TLS 加密；可随时 `/unlink` 停用机器人。

## 管理员/部署方须知（实现建议）

- OCR 提供商：
  - 本地：`tesseract`（低成本，需正确语言包与版面分析）；
  - 云服务：如 Azure、GCP、AWS（更稳健，注意成本与速率限制）。
- 关键配置（建议通过环境变量）：
  - `OCR_PROVIDER`：`tesseract|azure|gcp|aws`；
  - `OCR_LANGS`：`eng+chi_sim` 等；
  - `MAX_FILE_SIZE_MB`、允许 `MIME_TYPES`；
  - `RECEIPT_RETAIN_HOURS`：原始图片留存时长；对象存储（本地/S3）。
- 文件获取：
  - 使用 Telegram File API 获取文件；下载后送入 OCR；
  - 设置下载/识别超时与重试；根据 `file_unique_id` 做去重缓存（幂等）。
- 解析与打分：
  - 通过关键字（合计/Total/Amount Due/应付）与行内货币符号定位金额候选；
  - 对金额候选打分并返回多候选；
  - 时间解析结合 OCR 文本与文件时间元数据，按用户时区落库 UTC；
  - 提取商户名/抬头作为备注，结合用户的常用商户→分类规则做分类建议。
- 幂等与可观测：
  - 写操作携带 `Idempotency-Key`；
  - 透传 `X-Request-Id`，日志区分用户与文件 ID；
  - 触达限额时友好降级，提示稍后重试。

本功能与“自然语法/命令式录入”一致走相同确认与撤销流程，可作为日常记账的快速入口。


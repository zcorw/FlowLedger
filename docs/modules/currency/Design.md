# 货币管理模块 详细设计

## 假设与澄清点
- 汇率来源单一且可配置；失败时使用最近可用汇率（含“新鲜度”阈值）。
- 仅支持法币与主流加密币，使用 ISO 代码作为主键。
- 保留历史汇率用于回溯计算与报表。

### 1. 模块概述
- 职责：维护货币清单、管理历史汇率、提供统一换算服务。
- 依赖：外部汇率源（HTTP）；被消费/存款/借贷/调度模块调用。
- 使用场景：定时拉取汇率、用户/系统发起的换算请求。

### 2. 功能设计
- 功能清单
  | 编号 | 名称 | 说明 | 优先级 |
  |---|---|---|---|
  | C-01 | 货币清单 | 管理可用货币、精度与显示信息 | 高 |
  | C-02 | 汇率拉取 | 定时/按需拉取并缓存 | 高 |
  | C-03 | 历史查询 | 指定时间点获取历史汇率 | 高 |
  | C-04 | 换算服务 | 金额跨币种换算（历史/实时） | 高 |
  | C-05 | 新鲜度控制 | 汇率过期阈值校验与降级 | 中 |
- 核心业务规则
  - 金额使用 DECIMAL(20,6)，舍入策略默认四舍五入至 2–6 位可配置。
  - 换算公式：amount_to = amount_from × rate(from→to, at_time)。
  - 新鲜度：若超时阈值则告警，支持“最近可用”回退。
- 异常与补偿策略
  - 外部超时/失败：重试（指数退避），使用缓存回退并打标“stale_rate”。

### 3. 数据逻辑设计（概念层）
- 主要对象
  - Currency(code, name, symbol, scale)
  - ExchangeRate(base_code, quote_code, rate, source, fetched_at, valid_at)
- 对象关系
  - Currency 1—N ExchangeRate（按 base/quote 聚合）
- 跨模块数据流
  - 提供换算与历史汇率查询能力，被各模块调用。

### 4. 模块交互与流程
- 定时任务获取汇率→校验→落库→更新缓存→发布“汇率更新”事件（可选）。
- 换算请求→命中缓存或读取历史→返回金额与标记（实时/历史/过期）。

### 5. 接口说明（结构级，不含OpenAPI）
- 提供接口
  - get_rate(base, quote, at?): 返回 rate、valid_at、is_stale
  - convert(amount, from, to, at?): 返回换算金额、使用的汇率时间点
  - list_currencies(): 返回可用货币
- 权限控制与访问限制
  - 内部服务接口；仅认证后可访问。
- 幂等性与速率限制
  - 定时拉取按“source+timestamp”幂等；对外接口按用户/API 限流。

### 6. 日志与监控
- 监控指标：rate_fetch_success、rate_freshness_seconds、convert_latency_ms
- 关键日志点：source、base/quote、valid_at、is_stale、error_code

### 7. 测试与验收标准
- 测试范围：历史点换算、过期汇率回退、精度/舍入校验、拉取失败重试
- 验收标准：Given 汇率有效 When 换算 Then 返回正确金额与时间点
- Mock/隔离：模拟外部汇率源与超时/错误，使用固定种子数据回放。

### 8. 模块扩展与未来优化方向
- 多数据源与仲裁、三角套利修正、离线批量导入、前置边缘缓存


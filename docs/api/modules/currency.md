# è´§å¸æ¨¡å— API è®¾è®¡è¯´æ˜

## 1. æ¨¡å—æ¦‚è¿°ä¸è¾¹ç•Œ
- èŒè´£ï¼šè´§å¸æ¸…å•ã€å†å²æ±‡ç‡ã€ç»Ÿä¸€æ¢ç®—ã€å¿«ç…§å¯¼å…¥
- ä¸Šæ¸¸ï¼šå¤–éƒ¨æ±‡ç‡æºï¼›ä¸‹æ¸¸ï¼šæ¶ˆè´¹/å­˜æ¬¾/å€Ÿè´·ç»Ÿè®¡å±•ç¤º
- å®‰å…¨ï¼šè¯»ä¸ºä¸»ã€‚æœ¬é˜¶æ®µä¸åŒºåˆ†æ™®é€šç”¨æˆ·ä¸ç®¡ç†å‘˜ï¼ˆè§ç¬¬ 9 èŠ‚å†™æ¥å£è¯´æ˜ï¼‰ï¼Œåç»­å¯å¼•å…¥ RBAC æ”¶ç´§æƒé™ã€‚

## 2. èµ„æºæ¨¡å‹
- Currencyï¼šä¸»é”® `code`ï¼ˆISO 4217ï¼‰
- ExchangeRateï¼šä¸»é”® `(base, quote, date)`ï¼›ç»´åº¦ï¼šæ—¥æœŸã€å¸å¯¹
- ConvertRequestï¼šé‡‘é¢æ¢ç®—è¯·æ±‚ï¼ˆfromã€toã€dateï¼‰

## 3. ç«¯ç‚¹ä¸€è§ˆ
| è·¯å¾„ | æ–¹æ³• | ç”¨é€” | å¹‚ç­‰ | å¤‡æ³¨ |
|---|---|---|---|---|
| /v1/currencies | GET | è´§å¸æ¸…å•åˆ—è¡¨/æœç´¢ | n/a | æ”¯æŒåˆ†é¡µ/è¿‡æ»¤ |
| /v1/currencies/{code} | GET | è´§å¸è¯¦æƒ… | n/a | 404 ä¸å­˜åœ¨ |
| /v1/exchange-rates | GET | å†å²æ±‡ç‡æŸ¥è¯¢ | n/a | æ”¯æŒ base/quote/date åŒºé—´ |
| /v1/convert | POST | é‡‘é¢æ¢ç®— | æ”¯æŒ | è¯·æ±‚ä½“å¯æ‰¹é‡ |

## 4. å­—æ®µä¸éªŒè¯è§„åˆ™
- codeï¼šé•¿åº¦=3ï¼ŒA-Zï¼›
- rateï¼š>0ï¼Œç²¾åº¦ NUMERIC(20,10)ï¼›
- æ—¶é—´ï¼š`date`/`at` ä½¿ç”¨ UTC ISO8601ï¼Œä¸å…è®¸æœ¬åœ°æ—¶åŒºã€‚

## 5. é”™è¯¯ä¸å†²çªåœºæ™¯
- 422 éæ³•å¸ç§æˆ–æ—¥æœŸ
- 404 å½“æ—¥æ— æ±‡ç‡ä¸”ç¦æ­¢å›é€€
- 429 é«˜é¢‘æ‰¹é‡æ¢ç®—
- 503 ä¸Šæ¸¸ä¸å¯ç”¨ï¼ˆæœ¬åœ°æ— å¯ç”¨ç¼“å­˜æ—¶ï¼‰

## 6. ç¤ºä¾‹äº¤äº’
- GET /v1/exchange-rates?base=USD&quote=CNY&date=2025-01-15
- POST /v1/convert æ‰¹é‡å¤šç¬”é‡‘é¢

## 7. ç›‘æ§æŒ‡æ ‡
- rate_fetch_successã€rate_freshness_secondsã€convert_latency_ms

## 8. å˜æ›´ä¸å…¼å®¹
- æ–°å¢å¸ç§å­—æ®µï¼ˆå¦‚ç¬¦å·/åç§°æœ¬åœ°åŒ–ï¼‰æŒ‰å¯é€‰å­—æ®µå‘å¸ƒ

## 9. è´§å¸æ¸…å•ç®¡ç†æ¥å£ï¼ˆå½“å‰é˜¶æ®µä¸åŒºåˆ†æƒé™ï¼‰

è¯´æ˜ï¼šæœ¬é˜¶æ®µæš‚ä¸åŒºåˆ†â€œæ™®é€šç”¨æˆ·/ç®¡ç†å‘˜â€ï¼Œä»¥ä¸‹å†™æ¥å£å¯¹ä½¿ç”¨è€…ç»Ÿä¸€å¼€æ”¾ï¼›åç»­å¼•å…¥ RBAC æ—¶å¯æ”¶ç´§ä¸ºç®¡ç†å‘˜ä¸“ç”¨ï¼ˆå»ºè®® Scopeï¼š`write:currency_admin`ï¼‰ã€‚

- POST `/v1/currencies`
  - ç”¨é€”ï¼šåˆ›å»ºæˆ–å¹‚ç­‰æ›´æ–°å•ä¸ªè´§å¸ï¼ˆUpsertï¼‰ã€‚
  - å¹‚ç­‰ï¼šä»¥ `code` ä¸ºä¸šåŠ¡å”¯ä¸€é”®ï¼›æ”¯æŒ `Idempotency-Key` è¯·æ±‚å¤´ã€‚
  - è¯·æ±‚ä½“ï¼š`{ code, name, symbol?, scale }`ï¼ˆcode=ISO4217ï¼Œscale=0..6ï¼‰
  - å“åº”ï¼š201ï¼ˆæ–°å»ºï¼‰æˆ– 200ï¼ˆæ›´æ–°ï¼‰ï¼›422 æ ¡éªŒå¤±è´¥ï¼›409 ä¸šåŠ¡å†²çªï¼ˆå¯é€‰ï¼‰ã€‚

- PATCH `/v1/currencies/{code}`
  - ç”¨é€”ï¼šæ›´æ–°åç§°/ç¬¦å·/scaleã€‚
  - è¯·æ±‚ä½“ï¼š`{ name? , symbol? , scale? }`
  - å“åº”ï¼š200ï¼›404 ä¸å­˜åœ¨ã€‚

- PUT `/v1/currencies/bulk`
  - ç”¨é€”ï¼šæ‰¹é‡å¯¼å…¥/æ›´æ–°ï¼ˆUpsertï¼‰ã€‚
  - è¯·æ±‚ä½“ï¼šæ•°ç»„ï¼ˆé•¿åº¦å»ºè®® â‰¤1000ï¼‰ï¼Œæ¯é¡¹åŒ POST è§„åˆ™ã€‚
  - å“åº”ï¼š207 Multi-Status æˆ– 200ï¼Œè¿”å›é€é¡¹æˆåŠŸ/å¤±è´¥æ˜ç»†ã€‚

- DELETE `/v1/currencies/{code}`ï¼ˆå¯é€‰ï¼Œä¸æ¨èï¼‰
  - è¯´æ˜ï¼šå­˜åœ¨å¤–é”®å¼•ç”¨é£é™©ï¼Œä¸å»ºè®®ç‰©ç†åˆ é™¤ï¼›é»˜è®¤ä¸æä¾›åˆ é™¤æ¥å£ã€‚

- åˆ—è¡¨/æœç´¢è¡¥å……ï¼ˆåªè¯»ï¼‰
  - GET `/v1/currencies` è¿‡æ»¤ï¼š`code` ç²¾ç¡®ã€`q`ï¼ˆname/symbol æ¨¡ç³Šï¼‰ã€`page/page_size`ã€`sort=code,-name`ã€‚
  - GET `/v1/currencies/{code}` 404 ä¸å­˜åœ¨ã€‚

- ä¸ SQL çº¦æŸå¯¹é½
  - è¡¨ï¼š`currency.currencies(code, name, symbol, scale, created_at, updated_at)`ï¼›
  - çº¦æŸï¼š`code` ä¸»é”®ï¼›`scale` 0..6ï¼›æ›´æ–°è§¦å‘å™¨è‡ªåŠ¨åˆ·æ–° `updated_at`ã€‚

## 10. æ—¥å¿—æ‹‰å–æ±‡ç‡ï¼ˆsawazahmed0/exchange-apiï¼?
- æ¨¡å‹ï¼šç”¨ USD ä¸ºåŸºå‡†ï¼Œä»?`currency.currencies` ä¸­çš„å¸ç§ä¸ºâ€œåŸºå‡†æ¸…å•ã€å‡ºæœ‰æ±‡ç‡å¾—åˆ°ä¸ºå…¶ä»–å¸ç§æï¼Œå…¥åº“åˆ°æœ€æ–?`rate_date`/`rate`ï¼?
- è®¾å®šä»£ç ï¼šå®ƒé‡Œé¢ç›´æ¥ä¸€æ¬¡è°ƒç”¨ç½‘ç»œç”¨åº”ç»“æœï¼š`api/app/tasks/fetch_fx.py`ï¼Œç”¨é”™è¯¯æ‰¶èµ·ã€?
- ­h­Eå‚æ•°ï¼?  - `DATABASE_URL`ï¼šUostgreSQL è¿æ¥ã€?  - `FX_BASE`ï¼š[SD é»˜è®¤ï¼?  - `FX_TIMEOUT_MS` æˆ?`FX_TIMEOUT_SECONDS`ï¼?
- æ‰‹åŠ¿æ‰§è¡Œï¼?`cd api && python -m app.tasks.fetch_fx`
- å®šæ—¶ç¨‹åºç®¡ç†ï¼?  - Linux cron ä¾‹å¦‚ï¼šc0 9 * * * cd /path/to/Flow-Ledger/api && DATABASE_URL=... python -m app.tasks.fetch_fx >> /var/log/fx-sync.log 2>&1`  - Windows Task Scheduler ä¾‹å¦‚ï¼šsn Program/Script å…?`python`ï¼Œsrguments æ³¨å†Œ `-m app.tasks.fetch_fx`ï¼Œä»¥ `api` ä¸ºæ‰€åŠ é€è§¦å‘é‡ã€?

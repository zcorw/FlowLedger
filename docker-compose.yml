version: "3.9"

name: flow-ledger

services:
  db:
    image: postgres:12-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-flow_ledger}
      POSTGRES_USER: ${POSTGRES_USER:-flow_ledger}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-flow_ledger}
    ports:
      - "${PG_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
      interval: 5s
      timeout: 5s
      retries: 10
    volumes:
      - pgdata:/var/lib/postgresql/data
    networks:
      - flow_net

  db-migrate:
    image: postgres:12-alpine
    depends_on:
      db:
        condition: service_healthy
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-flow_ledger}
      POSTGRES_USER: ${POSTGRES_USER:-flow_ledger}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-flow_ledger}
    volumes:
      - ./:/work:ro
    working_dir: /work
    entrypoint: ["/bin/sh", "-lc"]
    command: >-
      'set -e;
       echo "Applying SQL schemas (deterministic order)...";
       apply() { echo "==> $$1"; PGPASSWORD=$$POSTGRES_PASSWORD psql -h db -U $$POSTGRES_USER -d $$POSTGRES_DB -v ON_ERROR_STOP=1 -f "$$1"; };
       # Enforce dependency order: extensions -> currency -> user -> deposit -> expense -> loan -> scheduler
       for f in \
         /work/sql/schema/extensions.sql \
         /work/sql/schema/currency.sql \
         /work/sql/schema/user.sql \
         /work/sql/schema/deposit.sql \
         /work/sql/schema/expense.sql \
         /work/sql/schema/loan.sql \
         /work/sql/schema/scheduler.sql; do \
           [ -f "$$f" ] && apply "$$f" || true; \
       done; \
       # Apply any remaining *.sql not covered above (extensions, views, etc.)
       for f in /work/sql/schema/*.sql; do \
         case "$$f" in \
           */extensions.sql|*/currency.sql|*/user.sql|*/deposit.sql|*/expense.sql|*/loan.sql|*/scheduler.sql) continue;; \
         esac; \
         apply "$$f"; \
       done; \
       if ls /work/sql/sample/*.sql >/dev/null 2>&1; then \
         echo "Applying sample data..."; \
         for f in /work/sql/sample/*.sql; do \
           apply "$$f"; \
         done; \
       else \
         echo "No sample data found (sql/sample)."; \
       fi; \
       if [ -f /work/scripts/run_migration.sql ]; then \
         echo "Applying scripts/run_migration.sql..."; \
         apply /work/scripts/run_migration.sql; \
       fi; \
       echo "Database migration job completed."'
    networks:
      - flow_net

  api:
    image: python:3.11-slim
    container_name: flow-ledger-api
    depends_on:
      db:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-flow_ledger}:${POSTGRES_PASSWORD:-flow_ledger}@db:5432/${POSTGRES_DB:-flow_ledger}
      # 根据实现选择 FastAPI/Flask；此处仅预留占位
      LOG_LEVEL: ${LOG_LEVEL:-info}
      UPLOAD_DIR: ${UPLOAD_DIR:-/data/uploads}
    volumes:
      - ./:/app
      - ${API_DATA_DIR:-./data/api}:/data
    working_dir: /app
    command: ["/bin/sh", "-lc", "echo 'API container is ready for development.' && tail -f /dev/null"]
    stop_signal: SIGTERM
    stop_grace_period: 30s
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:8000/v1/healthz')\""]
      interval: 10s
      timeout: 3s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M
    networks:
      - flow_net

  bot:
    image: python:3.11-slim
    container_name: flow-ledger-bot
    depends_on:
      db:
        condition: service_healthy
      api:
        condition: service_started
    environment:
      BOT_TOKEN: ${BOT_TOKEN:-REPLACE_ME}
      API_BASE_URL: ${API_BASE_URL:-http://api:8000/v1}
      DATABASE_URL: postgresql://${POSTGRES_USER:-flow_ledger}:${POSTGRES_PASSWORD:-flow_ledger}@db:5432/${POSTGRES_DB:-flow_ledger}
      DEFAULT_LANG: ${DEFAULT_LANG:-zh-CN}
      DEFAULT_TIMEZONE: ${DEFAULT_TIMEZONE:-UTC}
      DEFAULT_CURRENCY: ${DEFAULT_CURRENCY:-CNY}
      LOG_LEVEL: ${LOG_LEVEL:-info}
    volumes:
      - ./:/app
    working_dir: /app
    command: ["/bin/sh", "-lc", "echo 'Bot container is ready for development.' && tail -f /dev/null"]
    networks:
      - flow_net

  pgadmin:
    image: dpage/pgadmin4:8
    profiles: ["admin"]
    depends_on:
      db:
        condition: service_healthy
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_DEFAULT_EMAIL:-admin@example.com}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_DEFAULT_PASSWORD:-admin}
    ports:
      - "${PGADMIN_PORT:-8081}:80"
    networks:
      - flow_net

networks:
  flow_net:
    driver: bridge

volumes:
  pgdata:
    driver: local


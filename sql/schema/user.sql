-- Flow-Ledger User schema (PostgreSQL 12+)

CREATE SCHEMA IF NOT EXISTS "user";

CREATE OR REPLACE FUNCTION "user".tg_set_updated_at()
RETURNS trigger LANGUAGE plpgsql AS $$
BEGIN NEW.updated_at := now(); RETURN NEW; END $$;

CREATE TABLE IF NOT EXISTS "user".users (
  id               BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  username         TEXT   NULL UNIQUE,
  email            TEXT   NULL UNIQUE,
  password_hash    TEXT   NULL,
  password_salt    TEXT   NULL,
  last_login_at    TIMESTAMPTZ NULL,
  telegram_user_id BIGINT NULL UNIQUE,
  telegram_login_token TEXT NULL,
  is_bot_enabled   BOOLEAN NOT NULL DEFAULT true,
  email_verified_at TIMESTAMPTZ NULL,
  created_at       TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at       TIMESTAMPTZ NOT NULL DEFAULT now()
);

DROP TRIGGER IF EXISTS trg_users__upd ON "user".users;
CREATE TRIGGER trg_users__upd
BEFORE UPDATE ON "user".users
FOR EACH ROW EXECUTE FUNCTION "user".tg_set_updated_at();

CREATE TABLE IF NOT EXISTS "user".user_prefs (
  id            BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id       BIGINT NOT NULL UNIQUE REFERENCES "user".users(id) ON DELETE CASCADE,
  base_currency TEXT   NOT NULL REFERENCES currency.currencies(code) ON DELETE RESTRICT,
  timezone      TEXT   NOT NULL,
  language      TEXT   NOT NULL DEFAULT 'zh-CN',
  created_at    TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at    TIMESTAMPTZ NOT NULL DEFAULT now(),
  CONSTRAINT ck_user_prefs__tz CHECK (length(timezone) BETWEEN 1 AND 64)
);

DROP TRIGGER IF EXISTS trg_user_prefs__upd ON "user".user_prefs;
CREATE TRIGGER trg_user_prefs__upd
BEFORE UPDATE ON "user".user_prefs
FOR EACH ROW EXECUTE FUNCTION "user".tg_set_updated_at();

CREATE INDEX IF NOT EXISTS idx_users__telegram_user_id
ON "user".users (telegram_user_id);

CREATE TABLE IF NOT EXISTS "user".auth_tokens (
  id           BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id      BIGINT NOT NULL REFERENCES "user".users(id) ON DELETE CASCADE,
  token        TEXT NOT NULL UNIQUE,
  token_type   TEXT NOT NULL,
  expires_at   TIMESTAMPTZ NULL,
  is_valid     BOOLEAN NOT NULL DEFAULT true,
  created_at   TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at   TIMESTAMPTZ NOT NULL DEFAULT now(),
  CONSTRAINT ck_auth_tokens__type CHECK (token_type IN ('email_verification','password_reset'))
);

DROP TRIGGER IF EXISTS trg_auth_tokens__upd ON "user".auth_tokens;
CREATE TRIGGER trg_auth_tokens__upd
BEFORE UPDATE ON "user".auth_tokens
FOR EACH ROW EXECUTE FUNCTION "user".tg_set_updated_at();

CREATE INDEX IF NOT EXISTS idx_auth_tokens__user_type
ON "user".auth_tokens (user_id, token_type);
